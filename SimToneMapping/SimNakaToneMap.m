function [renderImagePlanes] = SimNakaToneMap(inputImagePlanes,maxLum,x)% [renderImagePlanes] = SimBasicNakaMap(inputImagePlanes,maxLum,[x])%% Apply sigmoidal tone mapping to an input XYZ image, using Naka-Rushton% function.  If x = [semi n] is passed, it is used.  Otherwise, it is% solved for from the passed image data.%% 5/18/04   dhb     Wrote it.yPlane = inputImagePlanes(:,:,2);if (nargin < 3 | isempty(x))    meanLevel = mean(yPlane(:));    clipLevel = 4*meanLevel;    meanValue = 0.4;    clipValue = 0.95;    x = SimGetNakaRushtonParams([meanLevel clipLevel],[meanValue clipValue]);end% Get rid of negative valuesrenderImagePlanes = inputImagePlanes;index = find(renderImagePlanes < 0);if (~isempty(index))    renderImagePlanes(index) = 0;end% Find the scaling factor for non-zero pixelsindex = find(yPlane > 0);newY = maxLum*SimNakaRushton(x,yPlane(index));factor = newY ./ yPlane(index);for i = 1:3    temp = renderImagePlanes(:,:,i);    temp(index) = factor .* temp(index);    renderImagePlanes(:,:,i) = temp;end