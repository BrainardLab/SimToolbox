function [theStruct,buf] = SimWriteCustomField(file,fieldName,data,fieldType)% [theStruct,buf] = SimWriteCustomField(file,theStruct,fieldName,type)%% Write a single field of simulator data.%% 2/23/99  dhb  Wrote it.% Copyright (c) 1999 David Brainard and Philippe Longere.   All rights reserved.% If type is not passed, make best guess based on an% analysis of the data.if (nargin < 4)	if (isstruct(data))		fieldType = 'struct';	elseif (iscell(data))		if (strcmp(fieldName,'algorithms'))			fieldType = 'alg';		else			error('Unknown cell field passed as data');		end	elseif (isstr(data))		if (strcmp(fieldName,'comments'))			fieldType = 'comment';		else			fieldType = 'single';		end	elseif (length(data) == 1)		fieldType = 'single';	else		fieldType = 'table';	endend% Now write it based on typeswitch (fieldType)	% Single simple field	case 'single',		fprintf(file,['#Sim' SimOneUp(fieldName) '\n']);		if (isstr(data))			fprintf(file,'%s',data);		else			fprintf(file,'%g ',data);		end		fprintf(file,'\n#SimEnd\n\n');			% Comment	case 'comment',		fprintf(file,['#Sim' SimOneUp(fieldName) '\n']);		fprintf(file,'%s\n',data);		fprintf(file,'#SimEndComments\n');			% Simple table	case 'table',		fprintf(file,['#Sim#' SimOneUp(fieldName) '\n']);		[m,n] = size(data);		fprintf(file,'%g %g\n',m,n);		for i = 1:m			for j = 1:n							fprintf(file,'%g ',data(i,j));			end			fprintf(file,'\n');		end		fprintf(file,'\n');			% Algorithms.  Passed as cell array of strings.	case 'alg',		nAlgs = length(data);		for i = 1:nAlgs			fprintf(file,'#Sim#Alg %s\n',data{i});		end		fprintf(file,'\n');			% Structure	case 'struct',		fprintf(file,['##Sim' SimOneUp(fieldName) '\n']);		fields = fieldnames(data);		for i = 1:length(fields)			fprintf(file,['##Sim' SimOneUp(fields{i}) '\n']);			if (eval(['isstr(data.' fields{i} ')']))				eval(['fprintf(file,''%s'',data.' fields{i} ');']);			else				eval(['fprintf(file,''%g '',data.' fields{i} ');']);			end			fprintf(file,'\n');		end		fprintf(file,'##SimEnd\n\n');		% Surprise	otherwise,			error('Don''t know how to write passed type');end